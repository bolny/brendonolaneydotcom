<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-CA" xml:lang="en-CA">
<head>
<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<title>Brendon O'Laney</title>
<link rel="stylesheet" href="/css/style.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">Brendon O'Laney</h1>
<p class="subtitle">SNETL</p>
</header>
<h1 id="a-memory-efficient-etl-extract-transform-load-framework-in-python">A memory-efficient ETL (Extract-Transform-Load) framework in Python</h1>
<p>SNETL is modular and designed primarily to operate over large data sets and use a minimal amount of memory in order to keep costs low. It uses PostgreSQL streaming, and Amazon S3 multipart uploads to process data on a line-by-line basis.</p>
<p>A SNETL module has four main components:</p>
<ol>
<li>A database query. It can be as simple or complex as needed.</li>
<li>An ordered list of input columns from the query to enforce data integrity.</li>
<li>A transformer class.</li>
<li>An ordered list of output column.</li>
</ol>
<p>The extractor performs a database query which is streamed in one row at a time and transformed into a dictionary using the ordered list. Then the dictionary is fed into a custom transformer class which is inspired by Django Model Forms. The base class for the transformer handles common operations such as data sanitization. Finally the loader creates, or adds to an Amazon S3 multipart upload.</p>
<p>An example SNETL module:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>INPUT_COLUMNS <span class="op">=</span> [<span class="st">&#39;id&#39;</span>, <span class="st">&#39;email&#39;</span>, <span class="st">&#39;address&#39;</span>, <span class="st">&#39;created_at&#39;</span>, <span class="st">&#39;first_name&#39;</span>,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;last_name&#39;</span>, <span class="st">&#39;last_seen&#39;</span>]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>OUTPUT_COLUMNS <span class="op">=</span> [<span class="st">&#39;id&#39;</span>, <span class="st">&#39;email&#39;</span>, <span class="st">&#39;street1&#39;</span>, <span class="st">&#39;street2&#39;</span>, <span class="st">&#39;region&#39;</span>, <span class="st">&#39;city&#39;</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;state&#39;</span>, <span class="st">&#39;phone&#39;</span>, <span class="st">&#39;country&#39;</span>, <span class="st">&#39;postcode&#39;</span>, <span class="st">&#39;created_at&#39;</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;first_name&#39;</span>, <span class="st">&#39;last_name&#39;</span>, <span class="st">&#39;last_seen&#39;</span>]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>QUERY <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT users.&quot;id&quot;, users.&quot;email&quot;, users.&quot;address&quot;, users.&quot;createdAt&quot;,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="st">    users.&quot;first_name&quot;, users.&quot;last_name&quot;, users.&quot;last_seen&quot;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM users;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UsersTransformer(Transformer):</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Transformer for the users table with additional data.&quot;&quot;&quot;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform_address(<span class="va">self</span>):</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Flatten user address json data into discrete columns&quot;&quot;&quot;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    address_data <span class="op">=</span> <span class="va">self</span>.<span class="bu">input</span>.get(<span class="st">&#39;address&#39;</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> {</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;street1&#39;</span>: address_data.get(<span class="st">&#39;street1&#39;</span>, <span class="st">&quot;&quot;</span>),</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;street2&#39;</span>: address_data.get(<span class="st">&#39;street2&#39;</span>, <span class="st">&quot;&quot;</span>),</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;region&#39;</span>: address_data.get(<span class="st">&#39;region&#39;</span>, <span class="st">&quot;&quot;</span>),</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;city&#39;</span>: address_data.get(<span class="st">&#39;city&#39;</span>, <span class="st">&quot;&quot;</span>),</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;state&#39;</span>: address_data.get(<span class="st">&#39;state&#39;</span>, <span class="st">&quot;&quot;</span>),</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;phone&#39;</span>: address_data.get(<span class="st">&#39;phone&#39;</span>, <span class="st">&quot;&quot;</span>),</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;country&#39;</span>: address_data.get(<span class="st">&#39;country&#39;</span>, <span class="st">&quot;&quot;</span>),</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;postcode&#39;</span>: address_data.get(<span class="st">&#39;postcode&#39;</span>, <span class="st">&quot;&quot;</span>),</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> output</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> etl():</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Extractor(QUERY, INPUT_COLUMNS) <span class="im">as</span> extractor:</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Loader(S3_BUCKET, S3_KEY, OUTPUT_COLUMNS) <span class="im">as</span> loader:</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> row <span class="kw">in</span> extractor:</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        transformer <span class="op">=</span> UsersTransformer(row, OUTPUT_COLUMNS)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>        transformed_row <span class="op">=</span> transformer.transform()</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>        loader.load(transformed_row)</span></code></pre></div>
<p>The SNETL framework has allowed us to quickly and efficiently make intelligence data available to operations using data visualization solutions such as Amazon Quicksight. Since its introduction we have seen a dramatic decrease in amount of developer time devoted to running database queries in order to surface intelligence data.</p>
<p><a href="./index.html">Back</a> <a href="../index.html">Home</a></p>
</body>
</html>
